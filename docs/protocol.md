# Описание протокола

Для взаимодействия между клиентом и сервером используется клиент-серверный протокол, основанный на TCP.
Клиент и сервер общаются между собой пакетами определенного формата.

Байты передаются в формате Big-Endian

# Пакеты 

Каждый пакет имеет собственную структуру. 
Каждый пакет первым байтом имеет маркерный байт, указывающий на его тип.
Для удобства, маркеры представляются символами ASCII.
Далее, содержимое определяется типом пакета.

Используемые в пакетах типы:

| Название | Длина                   | Описание                                                                                                                                                                   |
|----------|-------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Byte     | 1 байт                  | Одиночный байт                                                                                                                                                             |
| Int32    | 4 байта                 | Целочисленное значение                                                                                                                                                     |
| String   | 4 байта + массив байтов | Представление строкового значение. <br/> Первые 4 байта указывают длину строки. <br/> Дальше идет массив байтов указанной прежде длины. <br/> Используется кодировка UTF-8 |
| Bool     | 1 байт                  | Логический тип. <br/> `false` - байт 0 <br/> `true` - байт 1                                                                                                               | 
| Buffer   | 4 байта + массив байтов | Представляет собой буфер фиксированной длины. Длина указывается в первых 4 байтах (целочисленное значение).                                                                |
Если после названия типа в скобках указано значение, то оно используется в качестве константы для этого поля.

## Data Request

Пакет, передающий основной запрос к узлу. 
Тело представляет собой сериализованное тело команды.
После маркера идет 4 байтное целое число, определяющее длину тела 

Формат пакета:

| Marker    | Payload |
|-----------|---------|
| Byte('D') | Buffer  |

## Data Response

Пакет, передающий ответ на запрос операции.
После маркера указывается 4 байтная длина тела запроса.
Содержимое тела зависит от переданного прежде **Data Request**

Формат пакета:

| Marker    | Payload |
|-----------|---------|
| Byte('d') | Buffer  |

## ErrorResponse

Пакет посылаемый клиенту сервером, если возникла ошибка при выполнении.
Описание ошибки представлено в поле 'Message'

Формат:

| Marker    | Message | 
|-----------|---------|
| Byte('e') | String  |

## NotALeader

Пакет отправляется сервером, если на узел не являющийся лидером в кластере пришла модифицирующая команда.

В поле 'LeaderId' указывается ID узла лидера текущего кластера.
При получении этого пакета, необходимо переадресовать присланный прежде пакет узлу с указанным Id.

Формат:

| Marker    | LeaderId |
|-----------|----------|
| Byte('l') | Int32    |


## AuthorizationRequest

Пакет отправляется клиентом после установления соединения.
Используется для авторизации клиента сервером.


Формат:

| Marker    | AuthType | Data |
|-----------|----------|------|
| Byte('A') | Byte     | .... |

Поле 'AuthorizationType' является маркером алгоритма авторизации.
Поле 'Data' зависит от значения поля 'AuthorizationType' и в зависимости от типа может содержать любые значения.

Текущие методы авторизации

| Маркер    | Описание        | Поле 'Data'       |
|-----------|-----------------|-------------------|
| Byte('N') | Без авторизации | Тело отсутствует  |

## AuthorizationResponse

Отправляется сервером по завершении процесса авторизации.
Используется для сигнализации клиенту о завершении процесса авторизации и отправке результата авторизации.

Формат:

| Marker    | Success | Reason |
|-----------|---------|--------|
| Byte('a') | Bool    | String | 

`Success` - успешно ли завершился процесс авторизации. Если значение `false`, то поле `Reason` присутствует и содержит описание ошибки авторизации.

Если авторизация прошла неуспешно, то сервер закрывает соединение.

## BootstrapRequest

Отправляется клиентом после успешного процесса авторизации.
Требуется для проверки версии и выставлении настроек для общения с сервером.

> На текущий момент требуется только для проверки версии

Формат:

| Marker    | MajorVersion | MinorVersion | PatchVersion |
|-----------|--------------|--------------|--------------|
| Byte('B') | Int32        | Int32        | Int32        |

Первые 3 числа в пакете указывают на версию клиента. 
В TaskFlux используется семантическое версионирование. 

## BootstrapResponse

Отправляется сервером в ответ на `BootstrapRequest` пакет.

Формат

| Marker    | Success | Reason |
|-----------|---------|--------|
| Byte('b') | Bool    | String |

Поле `Success` указывает на успешность выставления настроек.

Если поле `Success` выставлено в `true`, то поле `Reason` отсутствует.

