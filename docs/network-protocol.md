# Описание протокола

Для взаимодействия между клиентом и сервером используется клиент-серверный протокол, основанный на TCP.
Клиент и сервер общаются между собой пакетами определенного формата.

Байты передаются в формате Big-Endian

# Пакеты 

Каждый пакет имеет собственную структуру. 
Каждый пакет первым байтом имеет маркерный байт, указывающий на его тип.
Для удобства, маркеры представляются символами ASCII.
Далее, содержимое определяется типом пакета.

Используемые в пакетах примитивные типы данных:


| Название | Длина                   | Диапазон                                    | Описание                                                                                                                                                                   |
|----------|-------------------------|---------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Byte     | 1 байт                  | [0; 255]                                    | Беззнаковое, целое число                                                                                                                                                   | 
| Int32    | 4 байта                 | [-2147483648; 2147483647]                   | Знаковое, целочисленное значение.                                                                                                                                          |
| UInt32   | 4 байта                 | [0; 4294967295]                             | Беззнаковое, целочисленное значение.                                                                                                                                       |
| Int64    | 8 байт                  | [-9223372036854775808; 9223372036854775807] | Целочисленное значение                                                                                                                                                     |
| Bool     | 1 байт                  | [0; 1]                                      | Логический тип. <br/> `false` - байт 0 <br/> `true` - байт 1. <br/> На практике, любое значение отличное от нуля интерпретируется как `true`                               | 

Если после названия типа в скобках указано значение, то оно используется в качестве константы для этого поля.

Также используются составные типы данных:

| Название     | Базовый размер | Описание                                                                                                                                                                                                                     | Визуальное расположение  |
|--------------|----------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------|
| Array<T>     | 4 байта        | Обобщенный массив тип данных `T` фиксированного значения. <br/> Количество элементов указывается в начале пакета типа через `Int32`. Далее следуют значения типа друг за другом без специальных маркеров                     | Size(Int32) \| `T`[]     |
| String       | 4 байта        | Строковое значение. <br/> Первые 4 байта указывают длину строки. <br/> Дальше идет массив байтов указанной прежде длины. <br/> Используется кодировка UTF-8, если не указано иное                                            | Array<Byte>              |
| Buffer       | 4 байта        | Массив байт фиксированной длины. Длина указывается в первых 4 байтах (целочисленное значение).                                                                                                                               | Array<Byte>              |
| Pair<T1, T2> | -              | Пара из 2 значений типов `T1` и `T2`. Значения следуют друг за другом без специального маркера разделителя и маркера начала.                                                                                                 | `T1` \| `T2`             |
| Dict<T1, T2> | 4 байта        | Список из нескольких пар значений типов `T1` и `T2` (в T1 и T2 необходимо подставить реальный тип данных). <br/> Значения типов следуют друг за другом. <br/> Количество пар указывается в первых 4 байтах через `Int32`.    | Array<Pair<`T1`, `T2`>>  |

> Примечание: значения ключей в типе `Dict` могут повторяться 

## Command Request

Пакет, передающий основной запрос к узлу. 
Тело представляет собой сериализованное тело команды.
После маркера идет 4 байтное целое число, определяющее длину тела 

Формат пакета:

| Marker    | Payload |
|-----------|---------|
| Byte('C') | Buffer  |

Команды запроса представлены в [документации команд](commands.md#запросы)

## Command Response

Пакет, передающий ответ на запрос операции.
После маркера указывается 4 байтная длина тела запроса.
Содержимое тела зависит от переданного прежде **Data Request**

Формат пакета:

| Marker    | Payload |
|-----------|---------|
| Byte('c') | Buffer  |

Возможные ответы представлены в [документации команд](commands.md#ответы)

## ErrorResponse

Пакет посылаемый клиенту сервером, если возникла ошибка при выполнении.
Описание ошибки представлено в поле 'Message'

Формат:

| Marker    | Message | 
|-----------|---------|
| Byte('e') | String  |

## NotALeader

Пакет отправляется сервером, если на узел не являющийся лидером в кластере пришла модифицирующая команда.

В поле 'LeaderId' указывается ID узла лидера текущего кластера.
При получении этого пакета, необходимо переадресовать присланный прежде пакет узлу с указанным Id.

Формат:

| Marker    | LeaderId |
|-----------|----------|
| Byte('l') | Int32    |


## AuthorizationRequest

Пакет отправляется клиентом после установления соединения.
Используется для авторизации клиента сервером.


Формат:

| Marker    | AuthType | Data |
|-----------|----------|------|
| Byte('A') | Byte     | .... |

Поле 'AuthorizationType' является маркером алгоритма авторизации.
Поле 'Data' зависит от значения поля 'AuthorizationType' и в зависимости от типа может содержать любые значения.

Текущие методы авторизации

| Маркер    | Описание        | Поле 'Data'       |
|-----------|-----------------|-------------------|
| Byte('N') | Без авторизации | Тело отсутствует  |

## AuthorizationResponse

Отправляется сервером по завершении процесса авторизации.
Используется для сигнализации клиенту о завершении процесса авторизации и отправке результата авторизации.

Формат:

| Marker    | Success | Reason |
|-----------|---------|--------|
| Byte('a') | Bool    | String | 

`Success` - успешно ли завершился процесс авторизации. Если значение `false`, то поле `Reason` присутствует и содержит описание ошибки авторизации.

Если авторизация прошла неуспешно, то сервер закрывает соединение.

## BootstrapRequest

Отправляется клиентом после успешного процесса авторизации.
Требуется для проверки версии и выставлении настроек для общения с сервером.

> На текущий момент требуется только для проверки версии

Формат:

| Marker    | MajorVersion | MinorVersion | PatchVersion |
|-----------|--------------|--------------|--------------|
| Byte('B') | Int32        | Int32        | Int32        |

Первые 3 числа в пакете указывают на версию клиента. 
В TaskFlux используется семантическое версионирование. 

## BootstrapResponse

Отправляется сервером в ответ на `BootstrapRequest` пакет.

Формат

| Marker    | Success | Reason |
|-----------|---------|--------|
| Byte('b') | Bool    | String |

Поле `Success` указывает на успешность выставления настроек.

Если поле `Success` выставлено в `true`, то поле `Reason` отсутствует.

