# Описание

Это протокол, который используется для взаимодействия между узлами кластера.
Используемые типы данных описаны в [клиентском сетевом протоколе](client-network-protocol.md#бинарные-типы-данных).

> Замечание: для репликации используется рафт, поэтому названия команд выбраны таким образом

# Пакеты

## AppendEntriesRequest

Используется для отправки новых записей лога и Heartbeat (для поддержания в актуальном состоянии).
Если количество записей лога в поле `Entries` - 0, то это пакет Heartbeat.

Формат:

| Маркер    | ID отправителя | Коммит | Терм | Предшествующий терм | Предшествующий индекс | Кол-во записей | Терм записи | Данные записи | Чек-сумма |
|-----------|----------------|--------|------|---------------------|-----------------------|----------------|-------------|---------------|-----------|
| Byte('A') | UInt32         | UInt32 | Term | Term                | UInt32                | UInt32         | Term        | Buffer        | UInt32    |

Поля `Терм записи` и `Данные записи` образуют одну логическую запись лога.
Они повторяются столько, сколько указано в поле `Кол-во записей`.

Т.е. если в `Кол-во записей`:

- 0 - дальше ничего нет (Heartbeat запрос)
- 1 - дальше `Терм записи`|`Данные записи`
- 2 - дальше `Терм записи`|`Данные записи`|`Терм записи`|`Данные записи`

## AppendEntriesResponse

Отправляется в ответ на AppendEntriesRequest.

Формат:

| Маркер    | Терм | Успех |
|-----------|------|-------|
| Byte('a') | Term | Bool  |

Поля:

- `Терм` - терм, который был у узла.
  Если на момент запроса у принявшего узла был меньший терм, то он обновит свой терм.
- `Успех` - принял ли узел запрос.

## ConnectRequest

Отправляется одним узлом, когда тот хочет подключиться к другому узлу для коммуникации и репликации.

Формат:

| Маркер    | Id узла |
|-----------|---------|
| Byte('C') | Int32   |

## ConnectResponse

Отправляет узлом при получении им ConnectRequest пакета.
Уведомляет об успешности операции.
Если во время авторизации возникла ошибка (поле `Успех` - `false`),
то соединение разрывается.

Формат:

| Маркер    | Успех |
|-----------|-------|
| Byte('c') | Bool  |

## RequestVoteRequest

Используется, когда узел хочет отправить RequestVote запрос другому узлу.

Формат:

| Маркер    | Id узла | Терм узла | Терм последней записи | Индекс последней записи |
|-----------|---------|-----------|-----------------------|-------------------------|
| Byte('V') | Int32   | Term      | Term                  | UInt32                  |

## RequestVoteResponse

Используется для ответа на RequestVoteRequest пакет.

Формат:

| Маркер    | Терм | Успех |
|-----------|------|-------|
| Byte('v') | Term | Bool  |

## InstallSnapshotRequest

Используется, когда узел лидер хочет реплицировать состояние на узел последователь, если в логе нет нужных записей.

Формат:

| Маркер    | Терм | Id узла | Последний индекс | Последний терм |
|-----------|------|---------|------------------|----------------|
| Byte('S') | Term | Int32   | Int32            | Term           |

## InstallSnapshotChunk

Используется для отправки файла снапшота, после отправки `InstallSnapshotRequest` пакета.

Формат:

| Маркер    | Чанк   | Чек-сумма |
|-----------|--------|-----------|
| Byte('b') | Buffer | UInt32    |

Если размер буфера в поле `Чанк` равен 0, то это означает конец передачи файла.

## InstallSnapshotResponse

Используется для ответа на InstallSnapshotRequest и InstallSnapshotChunk.
Отправляется каждый раз после получения каждого чанка данных из InstallSnapshotRequest.
Нужен для уведомления о готовности принимать следующий чанк и, при необходимости, известить об изменении терма (только
больший может быть).

Формат:

| Маркер    | Терм |
|-----------|------|
| Byte('s') | Term |

## RetransmitRequest

Получившая сторона отправляет этот пакет, в случае если полученный пакет нарушил целостность.
Например, переданная чек-сумма и рассчитанная не равны.
Когда кто-то получает этот пакет, то он должен повторить отправку предварительно отправленного пакета.

| Маркер    |
|-----------|
| Byte('R') |

# Чек сумма

Чек сумма используется для проверки целостности принимаемого пакета.
Если не указывается иное - вычисляется для всего пакета (вместе с байтом маркера).

Для создания используется алгоритм CRC32:

- Начальное значение: 0xFFFFFFFF
- Полином: 0x04C11DB7
- Зеркалированный: Нет
- XorOut: 0x0

Замечание: параметры алгоритма такие же как и у CRC32/MPEG2
