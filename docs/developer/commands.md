# Команды

Данный документ описывает поддерживаемые типы команд и ответов на них.
Указанные команды передаются в теле Data Request и Data Response для запросов и ответов соответственно.

# Типы данных

Использованные типы данных те, что используются в [сетевом протоколе](network-protocol.md)

# Запросы

## Enqueue

Запрос на добавления записи в требуемую очередь.

Формат:

| Маркер | Очередь   | Ключ  | Данные |
|--------|-----------|-------|--------|
| 'E'    | QueueName | Int64 | Buffer |

## Dequeue

Запрос на получение записи из очереди.

Формат:

| Маркер | Очередь   |
|--------|-----------|
| 'D'    | QueueName |

## Count

Получить количество записей в очереди 

Формат:

| Маркер | Очередь   |
|--------|-----------|
| 'C'    | QueueName |

## Create Queue

Запрос на создание новой очереди задач.

Поле "Название очереди" должно представляться допустимым названием очереди (описано
в [спецификации](func-spec.md#название-очереди))

Формат:

| Маркер | Название очереди | Реализация | Максимальный размер очереди | Максимальный размер тела сообщения | Диапазон ключей                |
|--------|------------------|------------|-----------------------------|------------------------------------|--------------------------------|
| 'Q'    | QueueName        | Int32      | Int32                       | Int32                              | Nullable\<Pair\<Int64, Int64>> |

При успешно выполненной операции отправляется [Ok ответ](#ok).

Поля `Максимальный размер очереди` и `Максимальный размер тела сообщения` содержат в себе `Int32` - знаковое число.
Если в нем содержится `-1` (все биты установлены в 1), то это означает отсутствие значения.

### Реализации очереди

В этой таблице определены коды, используемые в поле `Реализация`.
Это поле определяет тип структуры, которая будет использоваться для нижележащей структуры хранения.

| Код | Код структуры                          | 
|-----|----------------------------------------|
| 1   | [`H4`](../queue.md#основанная-на-куче) |
| 2   | [`QA`](../queue.md#список-очередей)    |

> При указании `QA` необходимо задать политику ограничения диапазона ключей

Также отдельно выделяется код `0`. Это код по умолчанию. Если указан он, то выбирается структура по умолчанию.
На данный момент, это [`H4`](../queue.md#основанная-на-куче).

## Delete Queue

Запрос на удаление существующей очереди задач.

Поле "Название очереди" не должно быть пустой строкой, исходя из того, что это название очереди по умолчанию, а ее удалить нельзя.

Формат:

| Маркер | Название очереди |
|--------|------------------|
| 'R'    | QueueName        | 

При успешно выполненной операции отправляется [Ok ответ](#ok)

## List queues

Запрос на получение информации обо всех очередях, хранящихся в системе на момент запроса.

Формат:

| Маркер |
|--------|
| 'L'    |

В ответ отправляется [List Queues ответ](#list-queues-1).

# Ответы

В этой секции описаны пакеты, отправляемые в ответ на запросы.

## Dequeue

Ответ на [Dequeue запрос](#dequeue).

Если из очереди получилось получить данные, то в поле Success будет выставлено 1, в противном случае 0.
В зависимости от того, получилось ли извлечь данные (поле Success) будут выставлены остальные поля.
Если значение было получено, то остальные поля представлены, иначе дальше не будет данных

Формат:

| Маркер | Успех | Ключ  | Данные |
|--------|-------|-------|--------|
| 'd'    | Bool  | Int64 | Buffer |

Если данные присутствуют:

| Маркер | Успех      | Ключ  | Данные |
|--------|------------|-------|--------|
| 'd'    | Bool(true) | Int64 | Buffer |

Если данные отсутствуют:

| Маркер | Успех       |
|--------|-------------|
| 'd'    | Bool(false) | 

## Count

Ответ на Count запрос. Отправляется в ответ на [Count запрос](#count)

Поле "Количество" содержит количество элементов, находящихся в очереди.

Формат:

| Маркер | Количество |
|--------|------------|
| 'c'    | Int32      |

## Error

Ответ посылаемый в случае возникновения ошибки во время исполнения команды.
Эти типы ошибок относятся к бизнес-логике, а не самому приложению.

Примеры ошибок:
- Неправильное название очереди
- Очереди с указанным названием не существует
- Нарушено ограничение очереди (максимальный размер, диапазон ключей и т.д.)

Поля:

- `Тип ошибки` - маркерный байт указывающий на тип ошибки
- `Сообщение` - сообщение об ошибке

Формат:

| Маркер | Тип ошибки | Сообщение |
|--------|------------|-----------|
| 'x'    | Byte       | String    |

Типы ошибок:

| Маркер | Описание                                                    |
|--------|-------------------------------------------------------------|
| 0      | Неизвестная ошибка бизнес-логики                            |
| 1      | Указанное название очереди представляет невалидное значение |
| 2      | Очереди с указанным названием не существует                 |
| 3      | Очередь с указанным названием уже существует                |
| 4      | Превышен диапазон допустимых значений ключа                 |
| 5      | Указан неверный диапазон ключей                             |

## List queues

Отправляется в ответ на запрос [List queues](#list-queues).

Поле "Данные" содержит список информации о каждой очереди. 
Ключами являются названия очереди, а значениями словарь метаданных.
Пример метаданных, максимальный размер очереди

Формат:

| Маркер | Количество очередей | Название очереди | Размер очереди | Описание политик      |
|--------|---------------------|------------------|----------------|-----------------------|
| 'l'    | Int32               | QueueName        | Int32          | Dict\<String, String> |

> Поля `Название очереди`, `Размер очереди` и `Описание политик` формируют единую запись для одной очереди.
> Количество этих записей указано в поле `Количество очередей`.
> Можно трактовать это поле как размер массива из структур описания для каждой очереди.

Возможные метаданные очереди:

| Название         | Описание                          | Значение                                   |
|------------------|-----------------------------------|--------------------------------------------|
| max-queue-size   | Максимальный размер очереди       | Int32                                      |
| max-payload-size | Максимальная длина тела сообщения | Int32                                      |
| priority-range   | Разрешенный диапазон ключей       | Два Int64 разделенных пустой строкой (' ') | 

> Примечание: все значения передаются в виде строк (для гибкости).
> В столбце "Значение" таблицы указывается тип, который был сериализован в строку.

> Примечание: поле `Название` регистрозависимое

> Примечание: если поле необязательно, то должно отсутствовать: пустая строка тоже является валидным значением.
> Нельзя вставлять пустую строку для значения, которое отсутствует.

## Policy Violation

Этот ответ сигнализирует об ошибке, вызванной нарушением политик, установленных на очередь.

> Строго говоря, нарушение политики не является ошибкой (как например, отсутствие нужной очереди), поэтому выделил в
> отдельный пакет.

Формат:

| Маркер | Код политики | Дополнительные данные |
|--------|--------------|-----------------------|
| 'p'    | Int32        | ...                   |

Поле `Код политики` содержит число, характеризующее, какая политика была нарушена.

`Дополнительные данные` содержит поля, характерные для конкретной политики - для каждого типа свои.

### Общая политика

Код: `0`

Эта политика - общая. Как бы запасная на случай, если не найдется нужного кода.
Внутри себя она содержит только строку - сообщение-описание ошибки.

Формат:

| Маркер | Код политики | Сообщение |
|--------|--------------|-----------|
| 'p'    | Int32(0)     | String    |

### Максимальный размер очереди

Код: `1`

Эта политика описывает ограничение на размер очереди.
Описана в секции [максимальный размер очереди](../queue-policies.md#максимальный-размер-очереди).

Внутри себя содержит только целое число — максимальный размер очереди (поле `Максимальный размер`).

Формат:

| Маркер | Код политики | Максимальный размер |
|--------|--------------|---------------------|
| 'p'    | Int32(1)     | Int32               |

### Максимальный размер тела сообщения

Код: `2`

Эта политика описывает ограничение на размер тела сообщения.
Описана в секции [максимальный размер тела сообщения](../queue-policies.md#максимальный-размер-тела-сообщения).

Внутри себя содержит только целое число - максимальный размер тела сообщения (поле `Максимальный размер`).

| Маркер | Код политики | Максимальный размер |
|--------|--------------|---------------------|
| 'p'    | Int32(2)     | Int32               |

### Диапазон ключей

Код: `3`

Эта политика определяет возможный диапазон ключей, который можно указывать для записей в очереди.
Описана в секции [диапазон ключей](../queue-policies.md#диапазон-ключей).

Внутри себя содержит 2 числа - минимальное (поле `Минимальное значение`) и максимальное (поле `Максимальное значение`)
значение ключей.

| Маркер | Код политики | Минимальное значение | Максимальное значение |
|--------|--------------|----------------------|-----------------------|
| 'p'    | Int32(3)     | Int64                | Int64                 |

## Ok

Обобщенный ответ, сигнализирующий об успешно выполненном запросе.

Формат:

| Маркер |
|--------|
| 'k'    |
