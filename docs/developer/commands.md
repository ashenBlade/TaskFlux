# Команды

Данный документ описывает поддерживаемые типы команд и ответов на них.
Указанные команды передаются в теле Data Request и Data Response для запросов и ответов соответственно.

Эти же команды будут сериализованы в лог.

# Типы данных

Использованные типы данных те, что используются в [сетевом протоколе](network-protocol.md)

# Запросы

## Enqueue

Запрос на добавления записи в требуемую очередь.
Поле "Ключ" указывается в виде Int64 значения.
Поле "Данные" имеет длину указанную в поле "Длина"

Формат:

| Маркер | Очередь | Ключ  | Данные |
|--------|---------|-------|--------|
| 'E'    | String  | Int64 | Buffer |

## Dequeue

Запрос на получение записи из очереди.

Формат:

| Маркер | Очередь |
|--------|---------|
| 'D'    | String  |

## Count

Получить количество записей в очереди 

Формат:

| Маркер | Очередь |
|--------|---------|
| 'C'    | String  |

## Create Queue

Запрос на создание новой очереди задач.

Поле "Название очереди" должно представляться допустимым названием очереди (описано в [спецификации](func-spec.md#название-очереди))

Поле "Размер" указывает на максимальный размер очереди:
- `0` - без предела
- остальное - максимальный размер очереди

Формат:

| Маркер | Название очереди | Максимальный размер очереди | Максимальный размер тела сообщения | Диапазон ключей                |
|--------|------------------|-----------------------------|------------------------------------|--------------------------------|
| 'Q'    | QueueName        | Int32                       | Int32                              | Nullable\<Pair\<Int64, Int64>> |

При успешно выполненной операции отправляется [Ok ответ](#ok).

Поля `Максимальный размер очереди` и `Максимальный размер тела сообщения` содержат в себе `Int32` - знаковое число.
Если в нем содержится `-1` (все биты установлены в 1), то это означает отсутствие значения.

## Delete Queue

Запрос на удаление существующей очереди задач.

Поле "Название очереди" не должно быть пустой строкой, исходя из того, что это название очереди по умолчанию, а ее удалить нельзя.

Формат:

| Маркер | Название очереди |
|--------|------------------|
| 'R'    | String           | 

При успешно выполненной операции отправляется [Ok ответ](#ok)

## List queues

Запрос на получение информации обо всех очередях, хранящихся в системе на момент запроса.

Формат:

| Маркер |
|--------|
| 'L'    |

В ответ отправляется [List Queues ответ](#list-queues-1).

# Ответы

## Enqueue

Ответ на [Enqueue запрос](#enqueue).

Поле "Успех" содержит флаг успеха операции:
- `true` - значение добавлено в очередь
- `false` - не добавлено

Формат:

| Маркер | Успех |
|--------|-------|
| 'e'    | Bool  |

## Dequeue

Ответ на [Dequeue запрос](#dequeue).

Если из очереди получилось получить данные, то в поле Success будет выставлено 1, в противном случае 0.
В зависимости от того, получилось ли извлечь данные (поле Success) будут выставлены остальные поля.
Если значение было получено, то остальные поля представлены, иначе дальше не будет данных

Формат:

| Маркер | Успех | Ключ  | Данные |
|--------|-------|-------|--------|
| 'd'    | Bool  | Int64 | Buffer |

Если данные присутствуют:

| Маркер | Успех      | Ключ  | Данные |
|--------|------------|-------|--------|
| 'd'    | Bool(true) | Int64 | Buffer |

Если данные отсутствуют:

| Маркер | Успех       |
|--------|-------------|
| 'd'    | Bool(false) | 

## Count

Ответ на Count запрос. Отправляется в ответ на [Count запрос](#count)

Поле "Количество" содержит количество элементов, находящихся в очереди.

Формат:

| Маркер | Количество |
|--------|------------|
| 'c'    | Int32      |

## Error

Ответ посылаемый в случае возникновения ошибки во время исполнения команды.
Эти типы ошибок относятся к бизнес-логике, а не самому приложению.

Примеры ошибок:
- Неправильное название очереди
- Очереди с указанным названием не существует
- Нарушено ограничение очереди (максимальный размер, диапазон ключей и т.д.)

Поля:

- `Тип ошибки` - маркерный байт указывающий на тип ошибки
- `Сообщение` - сообщение об ошибке

Формат:

| Маркер | Тип ошибки | Сообщение |
|--------|------------|-----------|
| 'x'    | Byte       | String    |

Типы ошибок:

| Маркер | Описание                                                    |
|--------|-------------------------------------------------------------|
| 0      | Неизвестная ошибка бизнес-логики                            |
| 1      | Указанное название очереди представляет невалидное значение |
| 2      | Очереди с указанным названием не существует                 |
| 3      | Очередь с указанным названием уже существует                |
| 4      | Превышен диапазон допустимых значений ключа                 |
| 5      | Указан неверный диапазон ключей                             |

## List queues

Отправляется в ответ на запрос [List queues](#list-queues).

Поле "Данные" содержит список информации о каждой очереди. 
Ключами являются названия очереди, а значениями словарь метаданных.
Пример метаданных, максимальный размер очереди

Формат:

| Маркер | Данные                              |
|--------|-------------------------------------|
| 'l'    | Dict\<String, Dict\<String, String> |

Возможные метаданные очереди:

| Название | Описание                                                                         | Значение | Обязателен |
|----------|----------------------------------------------------------------------------------|----------|------------|
| count    | Количество элементов в очереди (ее размер).                                      | UInt32   | +          |
| limit    | Максимальное размер очереди. Если поле отсутствует, то очередь предела не имеет. | UInt32   | -          |

> Примечание: все значения передаются в виде строк (для гибкости).
> В столбце "Значение" таблицы указывается тип, который был сериализован в строку.

> Примечание: названия регистрозависимые

> Примечание: если поле необязательно, то должно отсутствовать: пустая строка тоже является валидным значением.
> Нельзя вставлять пустую строку для значения, которое отсутствует.

## Ok

Обобщенный ответ, сигнализирующий об успешно выполненном запросе.

Формат:

| Маркер |
|--------|
| 'k'    |

