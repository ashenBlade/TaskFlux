---
title: Структура файлов
---

Здесь описаны файлы, которые использует приложение, и формат их содержимого.
Используемые типы данных находится в файле с общими [типами данных](network-protocol.md).

Все указанные файлы располагаются в базовой директории приложения: корень пути файла - базовая директория.

# Лог

## Описание

В этом файле содержатся дельты.
Описаны дальше.
Дельты содержатся в порядке их применения - если запись идет раньше, то ее нужно применять раньше.

## Расположение

Располагается в `consensus/log.raft`.

Если этого файла нет, то значит лога дельт нет.
При необходимости, этот файл создается.

## Формат файла

Общий формат файла:

| Маркер  | Версия | Терм  | Дельта       |
|---------|--------|-------|--------------|
| Byte(4) | Int32  | Int32 | Array\<Byte> |

Поле `Дельта` содержит данные дельты.
Оно содержит в себе как нужный маркер, так и необходимые данные.
Структура данных содержится в секции [дельта](#дельта)

## Дельта

Дельта
: Изменение в состоянии приложения

На данный момент поддерживаются следующие типы:

- Create - Создание очереди
- Delete - Удаление очереди
- Add - Добавление записи в очередь
- Remove - Удаление записи из очереди

Для каждого из типа определены собственные форматы данных и маркеры.

### CreateQueue

Создание новой очереди.

Формат:

| Маркер    | Название очереди | Реализация | Максимальный размер очереди | Максимальный размер сообщения | Диапазон ключей                |
|-----------|------------------|------------|-----------------------------|-------------------------------|--------------------------------|
| Byte('C') | QueueName        | Int32      | Int32                       | Int32                         | Nullable\<Pair\<Int64, Int64>> | 

Поле `Реализация` содержит код реализации, который нужно использовать

### DeleteQueue

Удаление существующей очереди

Формат:

| Маркер    | Название очереди |
|-----------|------------------|
| Byte('D') | QueueName        |

### AddRecord

Добавить в очередь новую запись

Формат:

| Маркер    | Название очереди | Ключ  | Сообщение |
|-----------|------------------|-------|-----------|
| Byte('A') | QueueName        | Int64 | Buffer    |

### RemoveRecord

Удалить указанную запись из очереди

| Маркер    | Название очереди | Ключ  | Сообщение |
|-----------|------------------|-------|-----------|
| Byte('R') | QueueName        | Int64 | Buffer    |

# Снапшот

## Описание

В этом файле хранится готовый слепок приложения - все очереди с их параметрами и записями.

## Расположение

Располагается в `consensus/raft.snapshot`

Содержит данные о всех существовавших очередях в приложении на момент создания снапшота.
Порядок хранения очередей не задается - могут идти в любом порядке.

## Формат данных

Структура файла:

| Маркер | Последний индекс | Последний терм | Состояние         |
|--------|------------------|----------------|-------------------|
| Marker | Int32            | Int32          | Array\<QueueData> |

Поле `Очереди` состоит из идущих друг за другом структур `QueueData`. Эта структура представляет описание одной очереди
вместе с ее записями.
Формат структуры `QueueData` представлен ниже:

| Название очереди | Реализация | Максимальный размер очереди | Максимальный размер сообщения | Диапазон ключей                | Данные очереди                       |
|------------------|------------|-----------------------------|-------------------------------|--------------------------------|--------------------------------------|
| QueueName        | Int32      | Int32                       | Int32                         | Nullable\<Pair\<Int64, Int64>> | Array\<Pair\<Int64, Array\<byte>>[]> |

Поле `Очередь` содержит повторяющиеся сериализованные значения всех элементов очереди - пара приоритет-нагрузка.
Количество элементов определяется полем `Размер очереди`.

Поля:

- `Название очереди` - название очереди
- `Реализация` - код реализации очереди, указывается

> Замечание: данные в очереди необязательно должны быть в правильной очередности, очередь восстанавливается во время
> старта из этих значений.

# Метаданные

## Описание

В этом файле содержатся метаданные, которые необходимы для корректной работы алгоритма консенсуса.

## Расположение

Располагается в `consensus/raft.metadata`

## Формат файла

Файл занимает немного места и состоит из нескольких фиксированных по размеру полей.

Структура файла:

| Маркер  | Версия | Терм  | Голос |
|---------|--------|-------|-------|
| Byte(4) | Int32  | Int32 | Int32 |

Поля:

- `Маркер` - специальный маркер файла
- `Версия` - версия файла
- `Терм` - последний сохраненный терм
- `Голос` - значение ID узла, за который голосовали последний раз.
  0 означает отсутствие голоса. Отрицательные значения не допускаются.
