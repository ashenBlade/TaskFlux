# Описание протокола

Для взаимодействия между клиентом и сервером используется клиент-серверный протокол, основанный на TCP.
Используемые структуры данных описаны в секции [сетевого протокола](network-protocol.md#структуры-данных).

## Command Request

Пакет, передающий основной запрос к узлу.
Тело представляет собой сериализованные данные команды.
После маркера идет 4 байтное целое число, определяющее длину тела.

Формат пакета:

| Маркер    | Данные |
|-----------|--------|
| Byte('C') | Buffer |

Команды запроса представлены в [документации команд](commands.md#запросы).

## Command Response

Пакет, передающий ответ на запрос операции.
После маркера указывается 4 байтная длина тела запроса.
Содержимое тела зависит от переданного прежде **Data Request**

Формат пакета:

| Marker    | Payload |
|-----------|---------|
| Byte('c') | Buffer  |

Возможные ответы представлены в [документации команд](commands.md#ответы)

## ErrorResponse

Пакет посылаемый клиенту сервером, если возникла ошибка при выполнении.
Описание ошибки представлено в поле 'Message'

Формат:

| Marker    | Message | 
|-----------|---------|
| Byte('e') | String  |

## NotLeader

Пакет отправляется сервером, если на узел не являющийся лидером в кластере пришла модифицирующая команда.

В поле 'LeaderId' указывается ID узла лидера текущего кластера.
При получении этого пакета, необходимо переадресовать присланный прежде пакет узлу с указанным Id.

Формат:

| Маркер    | Id лидера |
|-----------|-----------|
| Byte('l') | Int32     |

В случае, если на момент запроса лидера не было обнаружено, то поле `Id лидера` равняется `-1`.

## AuthorizationRequest

Пакет отправляется клиентом после установления соединения.
Используется для авторизации клиента сервером.


Формат:

| Marker    | AuthType | Data |
|-----------|----------|------|
| Byte('A') | Byte     | .... |

Поле 'AuthorizationType' является маркером алгоритма авторизации.
Поле 'Data' зависит от значения поля 'AuthorizationType' и в зависимости от типа может содержать любые значения.

Текущие методы авторизации

| Маркер    | Описание        | Поле 'Data'       |
|-----------|-----------------|-------------------|
| Byte('N') | Без авторизации | Тело отсутствует  |

## AuthorizationResponse

Отправляется сервером по завершении процесса авторизации.
Используется для сигнализации клиенту о завершении процесса авторизации и отправке результата авторизации.

Формат:

| Marker    | Success | Reason |
|-----------|---------|--------|
| Byte('a') | Bool    | String | 

`Success` - успешно ли завершился процесс авторизации. Если значение `false`, то поле `Reason` присутствует и содержит описание ошибки авторизации.

Если авторизация прошла неуспешно, то сервер закрывает соединение.

## BootstrapRequest

Отправляется клиентом после успешного процесса авторизации.
Требуется для проверки версии и выставлении настроек для общения с сервером.

> На текущий момент требуется только для проверки версии

Формат:

| Marker    | MajorVersion | MinorVersion | PatchVersion |
|-----------|--------------|--------------|--------------|
| Byte('B') | Int32        | Int32        | Int32        |

Первые 3 числа в пакете указывают на версию клиента. 
В TaskFlux используется семантическое версионирование. 

## BootstrapResponse

Отправляется сервером в ответ на `BootstrapRequest` пакет.

Формат

| Marker    | Success | Reason |
|-----------|---------|--------|
| Byte('b') | Bool    | String |

Поле `Success` указывает на успешность выставления настроек.

Если поле `Success` выставлено в `true`, то поле `Reason` отсутствует.

## ClusterMetadataRequest

Отправляется клиентом для получения метаданных кластера.
Необходим, когда клиент хочет получить данные для дальнейшей коммуникации с узлами кластера.

Формат:

| Маркер    |
|-----------|
| Byte('M') |

## ClusterMetadataResponse

Отправляется узлом в ответ на ClusterMetadataResponse пакет.
В нем указывается список адресов узлов кластера и Id текущего лидера кластера.

Формат:

| Маркер    | Адреса         | Id лидера | Id текущего узла |
|-----------|----------------|-----------|------------------|
| Byte('m') | Array\<String> | Int32     | Int32            |

Поле "Адреса" содержится массив строк. Каждая строка может быть либо IP адресом, либо названием хоста.

Поле "Id лидера" содержится Id текущего лидера кластера. Если все биты поля выставлены в 1, то это значит текущего
лидера нет.

Поле "Id текущего узла" содержит Id узла, вернувшего ответ.
