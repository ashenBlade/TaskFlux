# Введение

В этом документе буду описывать все пояснения по реализации.
Логично, полезно разработчикам и инженерам поддержки.
Бизнесу тут делать нечего.

# Структуры данных

## Название очереди

Название очереди представляется структурой `QueueName`.
Само название должно удовлетворять бизнес-требованиям, указанным в [функциональной спецификации](func-spec.md#название-очереди)

В качестве кодировки используется `ASCII`.
Выбранные допустимые символы образуют непрерывный диапазон кодов из таблицы.
Начинается с 33 `!`, заканчивающиеся 126 `~`.

Поэтому проверка будет тривиальной - проверка диапазона байта символа

Первые 127 символов `ASCII` совпадают с первыми символами `UTF-8`, поэтому в случае правильного назваания, кодировки можно использовать взаимозаменяемо.

Так как максимальная длина названия 255 символов соответствует максимальному значению байта и каждый символ занимает 1 байт, 
то длина строки названия указывается байтом (беззнаковым).

# Файловая система

## Базовая директория

Базовая директория наследуется от вызывающей программы. 
Поэтому, `TaskFlux` надо запускать из директории, в которой находятся нужные файлы для выполнения.

> TODO: может надо добавить возможность указывать базовую директорию при запуске

## Файловая структура

В базовой директории должны находиться все указанные файлы и каталоги для корректной работы приложения.
`*Base*` указывает на базовую директорию.

`*Base*`:

- `consensus` - директория, содержащая файлы необходимые для рафта
    - `raft.log` - файл с логом реплицируемых команд
    - `raft.metadata` - файл с метаданными узла (метаданные, необходимые для рафта)
    - `raft.snapshot` - файл слепка состояния системы для восстановления после старта

Каждый файл, относящийся к приложению, имеет специальный префикс.
Если этот префикс отсутствует или неправильный, то приложение должно упасть с ошибкой, в сообщении которой будет указана
эта причина.

### `consensus/raft.log`

Файл представляет лог команд для рафта.

Структура файла:

| Маркер  | Версия | Терм  | Данные       |
|---------|--------|-------|--------------|
| Byte(4) | Int32  | Int32 | Array\<Byte> |

Поля:

- `Маркер` - специальный маркер
- `Версия` - версия формата файла (текущая версия 1)
- `Терм` - терм, в которой команда была применена
- `Данные` - сериализованная данные команды для машины состояний

Поля `Терм` и `Данные` образуют логическую единицу - команду (в соответствии с алгоритмом рафта).
Они повторяются до конца файла.
Никаких маркеров начала/конца команды нет.

> Замечание: если сделаю фиксированный размер файла лога, то надо добавить маркеры начала/конца,
> иначе буду читать мусор

### `consensus/raft.metadata`

В этом файле содержатся общие метаданные, необходимые для корректной работы алгоритма.

Структура файла:

| Маркер  | Версия | Терм  | Есть голос | Голос |
|---------|--------|-------|------------|-------|
| Byte(4) | Int32  | Int32 | Bool       | Int32 |

Поля:

- `Маркер` - специальный маркер файла
- `Версия` - версия файла
- `Терм` - последний сохраненный терм
- `Есть голос` - значение поля `Голос` присутствует
- `Голос` - ID узла, за который голосовали последний раз

### `consensus/raft.snapshot`

В этом файле хранится слепок состояния приложения.

Структура файла:

| Маркер | Последний индекс | Последний терм | Состояние         |
|--------|------------------|----------------|-------------------|
| Marker | Index            | Term           | Array\<QueueData> |

Поле состояние состоит из идущих друг за другом структур `QueueData`.
Формат представлен ниже:

| Название очереди | Максимальный размер | Размер очереди | Очередь                      |
|------------------|---------------------|----------------|------------------------------|
| QueueName        | UInt32              | UInt32         | Pair\<Int64, Array\<byte>>[] |

Поле `Очередь` содержит повторяющиеся сериализованные значения всех элементов очереди - пара приоритет-нагрузка.
Количество элементов определяется полем `Размер очереди`.

> Замечание: данные в очереди необязательно должны быть в правильной очередности,
> очередь восстанавливается во время старта из этих значений. 